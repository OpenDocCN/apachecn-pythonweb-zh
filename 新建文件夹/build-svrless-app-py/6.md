# AWS Lambda 中的安全性

我们已经学习了如何在 AWS Lambda 中构建和配置无服务器函数。我们已经学习了如何使用第三方工具来扩展它们。我们还仔细研究了微服务是如何工作的，以及如何确保其中的安全性，同时确保弹性和速度。

在本章中，我们将了解 AWS 环境中的安全性，同时牢记 Lambda 函数。我们将了解 AWS VPC、安全组和子网等服务在 Lambda 功能方面的工作方式。

本章涵盖以下主题：

*   了解 AWS 专有网络
*   了解 VPC 中的子网
*   保护私有子网内的 Lambda
*   控制对 Lambda 函数的访问
*   在 Lambda 中使用 STS 实现基于会话的安全执行

# 了解 AWS 虚拟私有云（VPC）

在本节中，我们将了解 AWS VPC。**专有网络**是 AWS 环境安全层中非常常见的组件；它们是云的孤立部分，用户可以在其中托管服务和构建基础设施。专有网络是安全的第一层。我们将尝试在 Lambda 函数的上下文中以要点的形式理解 VPC，如下所示：

1.  可以在 AWS 的专有网络服务仪表板中创建和修改专有网络，如下所示：

![](images/3c3762c6-8790-4917-83b0-be9140b15f4d.png)

2.  现在，让我们快速了解如何创建自己的专有网络。为此，请单击创建专有网络。您将看到一个弹出框，要求您输入新 VPC 的更多元信息：

![](images/05c269c0-509c-4726-884e-3d3d35591a58.png)

3.  名称标签框需要有专有网络的名称。IPv4 CIDR 块是输入无类别域间路由的 IP 范围的位置。然后，您可以选择是否需要 IPv6 CIDR 块。您还可以选择租赁设置；这定义了 EC2 实例在 VPC 中的运行方式，以及相应的资源共享：

![](images/bfb7cd21-79f7-4ca8-b951-67ace4d70362.png)

4.  我们已成功创建了具有必要设置和 `Test-VPC` 名称的专有网络。我们可以在仪表板中看到这一点，以及所有相应的元设置：

![](images/8d2eafa5-fc67-4646-9bb3-ea6540b3ef71.png)

5.  您还可以看到 VPC 的摘要，其中包括 IPv4 设置、**网络访问控制列表**（**ACL**设置、**动态主机配置协议**（**DHCP**选项）以及 DNS 设置，所有这些都可以在以后根据我们的需要进行配置。您还可以在下一个 CIDR 块选项卡下看到 IPv4 CIDR 块：

![](images/95d20d08-7ee2-46a2-9544-0a57761b849a.png)

6.  我们还可以创建专有网络流量日志，记录进出专有网络的流量和数据移动。这将促进更好的日志管理、确保安全性和更好的监控。目前，尚未设置流量日志：

![](images/a5b7913b-6f53-4929-9df0-02f3822ad360.png)

7.  要创建 VPC 流量日志，只需单击底部的“创建流量日志”按钮。这将打开一个流日志创建向导，您可以在其中相应地输入各种设置的详细信息。创建向导如下所示：

![](images/6ff42f25-88e5-4c11-8f2f-9951893653e0.png)

8.  输入所有详细信息后，您可以继续并单击底部的创建流量日志选项，该选项将创建具有所需设置的 VPC 流量日志：

![](images/f657e092-032b-4488-a685-aa60fbbb6414.png)

9.  创建后，您可以在 flow Logs（流量日志）选项卡下看到新创建的 VPC 流量日志，如下所示：

![](images/c8f5cc05-8d7f-47d3-8e6f-1131ae27f94a.png)

10.  现在，让我们从 AWS Lambda 的角度来理解 VPC。与任何其他 AWS 资源一样，Lambda 功能也可以托管在 VPC 内。您可以在 AWS Lambda 函数的“网络”部分中看到该设置。看起来是这样的：

![](images/f56b1d48-07c6-4632-a861-1dffa46dcfd4.png)

11.  从下拉列表中，您可以选择要承载 Lambda 功能的 VPC：

![](images/830ca55c-9173-4960-a2dd-b8ae008ab76e.png)

12.  一旦您选择专有网络，它将进一步询问您有关子网、安全组等的详细信息，如下面的屏幕截图所示。我们将在以下章节中了解它们，因此，稍后我们将为我们的 Lambda 功能配置 VPC：

![](images/39fb6710-baff-401c-910a-e386c2af07e9.png)

# 了解 VPC 中的子网

在本节中，我们将了解 AWS 子网，它们是 AWS VPC 的子部分。专有网络可进一步划分为多个子网。这些子网可以是公共的，也可以是私有的，这取决于您的体系结构的安全需求。我们将从 AWS Lambda 函数的角度来研究子网的概念。

我们将执行以下步骤：

1.  您可以通过 VPC 页面本身进入子网菜单。您需要单击左侧 Your VPCs 选项下的 Subne t s 选项：

![](images/816d6fed-9461-4052-abf5-0ae138b16a8a.png)

2.  这将带您到子网控制台，在那里您将看到一些已经存在的子网。以下是您所在区域中每个可用性区域的默认子网：

![](images/46cc3156-ead4-4571-a4cd-7338e9c1b7ec.png)

3.  现在，要创建新的子网，您需要单击控制台左上方的蓝色创建子网按钮。在创建向导中，将要求您输入以下详细信息：子网名称、要放置子网的 VPC、可用性区域以及首选 IPv4 CIDR 块。我已将此子网放置在上一节中创建的 VPC 中：

![](images/e671fcdc-7f96-4d47-a99e-9d36d675418c.png)

4.  单击创建向导右下角的“是，创建”按钮时，将创建新的子网。您可以在控制台上的子网列表中看到它：

![](images/39f11fcc-ef44-4aed-8850-169adf828115.png)

5.  现在，我们将使用刚才创建的 VPC 和子网来填写 Lambda 函数的安全设置。目前，AWS Lambda 的网络设置如下所示：

![](images/ba7a0cd2-dc7a-4f33-bf3b-fac817f51bb1.png)

6.  在添加所需设置（VPC、子网和安全组的详细信息）后，Lambda 功能的网络设置如下所示：

![](images/f566c9d4-69a5-4d3d-b0a1-8b77bc44dc2c.png)
。。。

![](images/452cf8d2-5e41-489c-85d5-84ab3fae0f98.png)

7.  为 Lambda 功能设置网络设置后，单击 Lambda 控制台右上角的橙色保存按钮，将这些设置保存到 Lambda 功能。

# 保护私有子网内的 Lambda

**专用子网**是不向互联网开放的子网。他们的所有流量都使用路由表的概念通过同一 VPC 中的公共子网进行路由。让我们了解如何将 Lambda 函数放置在私有子网内，以添加额外的安全层：

1.  默认情况下，在 AWS 控制台中创建的子网不是专用的。让我们通过查看刚才创建的子网的详细信息来评估和确认这一点：

![](images/9aa312f6-84ce-4f26-a6ae-0bd9838d5fef.png)

2.  单击 Route Table（路由表）选项卡将向我们显示子网的路由设置，它基本上告诉我们允许哪种流量进入该子网：

![](images/bcb498f4-e225-472c-998c-b38b7f44f5a8.png)

3.  在网络 ACL 选项卡中，您可以看到为我们的子网分配的网络规则。在这里，我们可以看到子网对所有流量开放（0.0.0.0/0）。因此，为了使我们的子网私有化，我们需要解决以下问题：

![](images/1f89e289-50ab-457d-80c5-6e55a940d56e.png)

4.  单击控制台左侧的链接，转到网络 ACLs 控制台。您将到达以下页面：

![](images/3f01d910-b977-4ef2-af40-71052ce5a097.png)

5.  现在，单击蓝色的 createnetworkacl 按钮来创建一个新的 ACL。选择我们的 VPC，然后在创建向导中输入 ACL 的名称：

![](images/117d9fa7-b119-4019-bfe0-d5398ccfebb7.png)

6.  现在，在新 ACL 的入站规则中，添加以下规则。在“源”部分，添加任何公用子网的 IPv4 设置，然后单击“保存”：

![](images/eec95e92-7393-49bf-b225-ce3c956cca57.png)

7.  现在，将当前子网的 ACL 替换为将使子网成为专用子网的新 ACL：

![](images/4634f40c-262b-46f6-bf21-4da5234d2118.png)

现在，我们在一个私有子网中有了 Lambda 函数，使它更加安全。

# 控制对 Lambda 函数的访问

我们已经完成了确保 Lambda 功能和无服务器架构安全所需的所有安全设置。因此，从事无服务器系统的工程师在从安全角度设计其基础设施时，应牢记以下几点：

*   VPC 和子网设置可添加在 Lambda 功能的网络部分下
*   出于容错目的，建议将 Lambda 函数放置在至少两个子网之间。然而，这不是强制性的。
*   如果要将 Lambda 函数放置在专用子网中，则需要确保专用子网正在从该专有网络中的公用子网接收适当的通信量。如果没有，则 Lambda 函数基本上被锁定。

# 在 Lambda 中使用 STS 实现基于会话的安全执行

在从 Lambda 功能内部访问其他 AWS 服务和组件时，您可以使用**AWS 的简单令牌服务**（**STS**）来确保基于会话的访问，这将本质上增加一层额外的安全性。正如我们已经讨论并学习了如何在代码中使用 STS 凭据，我们将跳过文档链接

AWS STS 的官方文档将帮助您了解基于会话的访问是如何工作的：[https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) 。

这是在 Python 代码中使用 STS 凭据的*Boto3 Python 文档*：[http://boto3.readthedocs.io/en/latest/reference/services/sts.html](http://boto3.readthedocs.io/en/latest/reference/services/sts.html) 。

# 总结

在本章中，我们了解了安全性是如何在 Lambda 函数中以深入模式工作的。我们已经了解了专有网络和子网如何在 AWS 环境中工作。我们已经学会了创建专有网络，还创建了公共和私有子网。这将使您从 AWS 的整体角度更好地理解安全性是如何工作的。

我们还学习了如何将 Lambda 函数放置在我们在本章中创建的 VPC 和子网中。我们了解如何在专有网络和子网内处理和路由流量。

最后，我们还学习了如何使用对其他 AWS 组件的基于会话的访问在 Python 代码中实现更好的安全性，从而将安全性置于开发人员的控制之下

在下一章中，您将了解**无服务器应用程序模型**（**SAM**），以及如何编写 SAM 模型并通过它们部署 Lambda 应用程序。