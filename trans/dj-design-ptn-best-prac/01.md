# Django 和模式

在本章中，我们将讨论以下主题：

*   为什么是 Django？
*   Django 的故事
*   Django 是如何工作的？
*   什么是模式？
*   著名的模式集合
*   Django 中的模式

根据 Bowei Gai 的*世界创业报告*，2013 年全世界有超过 136000 家互联网公司，仅美国就有超过 60000 家。其中，87 家美国公司的价值超过 10 亿美元。另一项研究表明，在 27 个国家的 12000 名年龄在 18 岁至 30 岁之间的人中，超过三分之二的人看到了成为企业家的机会。

数字创业公司的这种创业热潮主要是由于创业公司的工具和技术变得廉价和无处不在。由于强大的框架，创建一个成熟的 web 应用程序所需的时间和技能比以前少得多。

物理学家、教育家、艺术家和其他许多没有软件工程背景的人正在创建有用的应用程序，这些应用程序大大推进了他们的领域。然而，他们可能不知道构建大型可维护软件所需的软件工程设计原则。

一项对挪威四种不同的基于 web 的应用程序实现的研究表明，具有已知代码气味和设计反模式的实现与维护困难直接相关。设计拙劣的软件可能也能正常工作，但在快速变化的世界中很难适应不断变化的需求。

初学者经常在项目后期发现设计问题。很快，他们就会试图解决其他人一次又一次面临的同样问题。这就是理解模式可以真正帮助他们节省时间的地方。

# 为什么是 Django？

每个 web 应用程序都是不同的，就像一件手工制作的家具。你很少能找到一个能完全满足你所有需求的批量生产的沙发。即使你从一个基本的需求开始，比如博客或社交网络，你的需求也会慢慢增长，你很容易会得到很多半生不熟的解决方案，这些解决方案被粘在一个曾经简单的曲奇切碎机解决方案上。

这就是为什么像 Django 或 Rails 这样的 web 框架变得非常流行的原因。框架加速了开发，并融入了所有最佳实践。但是，它们也足够灵活，可以让您使用刚好足够的管道进行作业。如今，web 框架无处不在，大多数编程语言至少有一个类似于 Django 的端到端框架。

Python 的 web 框架可能比大多数编程语言都多。快速查看**Python 包索引**（**PyPI**）会发现与 web 环境相关的 13045 个包。PythonWiki 列出了超过 54 个活跃的 web 框架，其中最流行的是 Django、Flask、Pyramid 和 Zope。Python 在框架方面也有很大的多样性。紧凑的[瓶子](https://bottlepy.org/docs/dev/)micro web 框架只是一个 Python 文件，它没有依赖性，能够令人惊讶地创建一个简单的 web 应用程序。

尽管有这些丰富的选择，Django 还是以巨大的优势成为人们的最爱。[Djangosites.org](https://www.djangosites.org/)列出了 5263 多个用 Django 编写的网站，包括 Instagram、Pinterest 和 Discus 等著名的成功案例。正如官方描述所说，Django（[https://djangoproject.com](https://djangoproject.com/) 是一个高级 Python web 框架，鼓励快速开发和干净实用的设计。换句话说，它是一个完整的 web 框架，与 Python 一样包含电池。

开箱即用的管理界面是 Django 的独特功能之一，对于早期的数据输入和管理非常有帮助。Django 的文档因其为开源项目编写得非常好而受到赞扬。

最后，Django 已经在几个高流量网站上进行了测试。它特别关注安全性，针对常见的攻击提供保护，如**跨站点脚本**（**XSS**）、**跨站点请求伪造**（**CSRF**）以及不断演变的安全威胁，如弱密码散列算法。

虽然从理论上讲，您可以使用 Django 构建任何类型的 web 应用程序，但它可能并不适合所有用例。例如，要在内存紧张的嵌入式系统中原型化一个简单的 web 服务，您可能需要使用 Flask，而最终可能会使用 Django，因为它的健壮性和特性。为作业选择正确的工具。

如果您习惯于其他 web 框架，一些内置功能（如管理界面）可能听起来很奇怪。为了理解 Django 的设计，让我们了解它是如何产生的。

# Django 的故事

当你看到埃及的金字塔时，你会认为这样一个简单而简约的设计一定非常明显。事实上，它们是 4000 年建筑演变的产物。阶梯金字塔，最初的（笨重的）设计，有六个大小逐渐减小的矩形块。经过几次建筑和工程方面的改进，现代的、玻璃化的、耐用的石灰石结构才发明出来。

看着 Django，你可能会有类似的感觉——它建造得如此优雅，一定是完美无瑕的构思。相反，这是重写和快速迭代的结果，在一个可以想象的最高压的环境中——一个新闻编辑室！

2003 年秋天，两名程序员阿德里安·霍洛瓦蒂（Adrian Holovay）和西蒙·威利森（Simon Willison）在《劳伦斯世界报》（Lawrence Journal World）的报纸上工作，他们正在堪萨斯州创建几个当地新闻网站。这些网站，包括[LJWorld.com](http://LJWorld.com)、[Lawrence.com](http://Lawrence.com)和[KUsports.com](http://KUsports.com)等，与大多数新闻网站一样，它们不仅是内容驱动的门户网站，充斥着文本、照片和视频，而且还不断尝试通过应用程序满足当地 Lawrence 社区的需求，例如本地业务目录、事件日历和分类广告。

# 一个框架诞生了

当然，这对西蒙、阿德里安和后来加入他们团队的雅各布·卡普兰·莫斯来说意味着大量的工作；期限很短，有时只有几个小时的通知。由于这是 Python web 开发的早期，他们不得不从头开始编写 web 应用程序。因此，为了节省宝贵的时间，他们逐渐将常见的模块和工具重构为一种称为*CMS*的东西。

最终，内容管理部分被拆分成一个名为**Ellington CMS**的独立项目，该项目后来成为一个成功的商业 CMS 产品。CMS 的其余部分是一个整洁的底层框架，其通用性足以用于构建任何类型的 web 应用程序。

到 2005 年 7 月，这个 web 开发框架以 Django（发音为 Jang Oh）的形式发布，并获得了开源**Berkeley 软件发行版**（**BSD**许可证。它是以传奇爵士吉他手 Django Reinhardt 的名字命名的。正如他们所说，剩下的就是历史了。

# 消除魔法

由于 Django 作为一种内部工具的起源并不起眼，因此它有许多劳伦斯杂志世界特有的古怪之处。为了使 Django 真正具有通用性，一项名为*的工作已经在进行中。*

然而，Django 开发人员必须进行的最重要的重构工作被称为*消除魔法*。这个雄心勃勃的项目涉及清理 Django 多年来积累的所有缺点，包括很多魔法（隐式特性的非正式术语）并用更自然、更明确的 Pythonic 代码替换它们。例如，模型类过去是从名为`django.models.*`的魔法模块导入的，而不是直接从定义它们的`models.py`模块导入的。

当时，Django 有大约十万行代码，这是对 API 的重大重写。2006 年 5 月 1 日，这些几乎相当于一本小书大小的更改被集成到 Django 的开发版本主干中，并作为 Django 0.95 版发布。这是迈向 Django 1.0 里程碑的重要一步。

# Django 越来越好了

每年，世界各地都会举行名为**DjangoCons**的会议，让 Django 开发人员彼此见面和互动。他们有一个可爱的传统，就是就*为什么 Django 如此糟糕*发表半幽默的基调。这可能是 Django 社区的成员，也可能是在竞争性 web 框架上工作的人，也可能是任何知名人士。多年来，Django 开发人员积极地接受了这些批评，并在随后的版本中减轻了这些批评，这令人惊讶。

以下是与 Django 中曾经存在的一个缺陷相对应的改进的简短摘要，这些改进在发行版中得到了解决：

*   新表单处理库（Django 0.96）
*   将管理与模型分离（Django 1.0）
*   多数据库支持（Django 1.2）
*   更好地管理静态文件（Django 1.3）
*   更好的时区支持（Django 1.4）
*   可自定义用户模型（Django 1.5）
*   更好的事务处理（Django 1.6）
*   内置数据库迁移（Django 1.7）
*   多模板引擎（Django 1.8）
*   简化的 URL 路由语法（Django 2.0）

随着时间的推移，Django 已经成为公共领域中最惯用的 Python 代码库之一。Django 源代码也是学习大型 Python web 框架体系结构的好地方。

# Django 是如何工作的？

要真正欣赏 Django，你需要窥视引擎盖下面，看看里面的各种运动部件。这既有启发性，也有压倒性。如果您已经熟悉以下信息，您可能希望跳过此部分：

![](img/8d9b7f4e-86e6-457c-961e-063cd08be920.png)

在典型的 Django 应用程序中如何处理 web 请求

上图显示了 web 请求从访问者浏览器到 Django 应用程序的简化过程。编号路径如下所示：

1.  浏览器将请求（基本上是一个字节字符串）发送到 web 服务器。
2.  您的 web 服务器（例如，Nginx）将请求移交给**web 服务器网关接口**（**WSGI**）服务器（例如，uWSGI）或直接从文件系统提供文件（例如，CSS 文件）。
3.  与 web 服务器不同，WSGI 服务器可以运行 Python 应用程序。该请求将填充一个名为`environ`的 Python 字典，并可以选择通过几层中间件，最终到达 Django 应用程序。
4.  项目的`urls.py`中包含的 URLconf（URL 配置）模块根据请求的 URL 选择一个视图来处理请求。请求已变成`HttpRequest`，一个 Python 对象。

5.  选定视图通常执行以下一项或多项操作：

A.通过模型与数据库对话

B 使用模板呈现 HTML 或任何其他格式化响应

C 返回纯文本响应（未显示）

D 引发了一个例外

6.  `HttpResponse`对象在离开 Django 应用程序时被渲染成字符串。
7.  在用户的浏览器中可以看到呈现精美的网页。

尽管省略了某些细节，但这种表示应该有助于您理解 Django 的高级体系结构。它还显示了关键组件（如模型、视图和模板）所扮演的角色。Django 的许多组件都基于几种著名的设计模式。

# 什么是模式？

**蓝图**、**脚手架**和**维护**之间有什么共同之处？这些软件开发术语是从建筑和建筑界借用来的。然而，最具影响力的术语之一来自于 1977 年由奥地利著名建筑师克里斯托弗·亚历山大（Christopher Alexander）及其团队（包括 Murray Silverstein、Sara Ishikawa 和其他几位建筑师）撰写的一篇关于建筑和城市规划的论文。

“模式”一词在他们的开创性著作*之后开始流行，这是一种模式语言：城镇、建筑、建筑*（五本书系列的第二卷），其基础是用户比任何建筑师都更了解他们的建筑。模式是指日常问题及其提出但经过时间检验的解决方案。

克里斯托弗·亚历山大在书中陈述如下：

“每种模式都描述了一个在我们的环境中反复出现的问题，然后描述了该问题解决方案的核心，这样您就可以多次使用该解决方案，而不必以同样的方式重复两次。”

例如，他的*光之翼*模式描述了人们如何喜欢自然采光较多的建筑，并建议将建筑布置成由翅膀组成。这些翅膀应该又长又窄，宽度不能超过 25 英尺。下一次，当你在一所古老大学的光线充足的长廊中漫步时，一定要感谢这种模式。

他们的书中包含了 253 种实用模式，从房间设计到整个城市的设计。最重要的是，这些模式中的每一个都为一个抽象问题命名，并共同形成了一个*模式语言*。

还记得你第一次遇到“似曾相识”这个词的时候吗？你可能会想：“*哇，我从来都不知道有一个词来形容这种体验。*类似地，建筑师不仅能够识别环境中的模式，而且最终还能够以同行能够理解的方式命名它们。

在软件世界中，术语设计模式是指软件设计中常见问题的通用可重复解决方案。它是开发人员可以使用的最佳实践的形式化。与架构领域一样，模式语言已经被证明非常有助于向其他程序员传达解决设计问题的某种方式。

有几个设计模式的集合，但其中一些比其他的更有影响力。

# 四人帮模式

研究和记录设计模式的最早努力之一是由*Erich Gamma*、*Richard Helm*、*Ralph Johnson*和*John Vlissides*撰写的一本名为*的设计模式：可重用面向对象软件的元素*的书，后来被称为**四人帮**（**GoF**）。这本书是如此有影响力，以至于许多人认为书中的 23 种设计模式是软件工程本身的基础。

事实上，这些模式主要是针对静态面向对象编程语言编写的，它在 C++和 SimalTalk 中有代码示例。正如我们将很快看到的，在其他具有更好的高阶抽象的编程语言（如 Python）中甚至可能不需要这些模式。

23 种模式按其类型大致分类如下：

*   **创造模式**：包括抽象工厂、构建者模式、工厂方法、原型模式和单例模式

*   **结构模式**：包括适配器模式、桥梁模式、复合模式、装饰模式、立面模式、轻量级模式和代理模式
*   **行为模式**：包括责任链模式、命令模式、解释模式、迭代器模式、中介模式、记忆模式、观察者模式、状态模式、策略模式、模板模式和访客模式

虽然对每种模式的详细解释超出了本书的范围，但确定 Django 实现本身中存在的一些模式将是一件有趣的事情：

| **GoF 模式** | **Django 组件** | **说明** |
| 命令模式 | HttpRequest | 这将请求封装在对象中 |
| 观察者模式 | 信号 | 当一个对象更改状态时，将自动通知并更新其所有侦听器 |
| 模板法 | 基于类的泛型视图 | 在不改变算法结构的情况下，可以通过子类化重新定义算法的步骤 |

虽然这些模式对那些研究 Django 内部的人来说最感兴趣，但最常见的问题是，Django 本身属于哪种模式？

# Django 是 MVC 吗？

**模型视图控制器**（**MVC**是施乐 PARC 在 70 年代发明的一种架构模式。作为 Smalltalk 中用于构建用户界面的框架，它在 GoF 书籍中得到了早期的提及。

如今，MVC 是 web 应用程序框架中非常流行的模式。常见问题的一个变体是 Django 是否是 MVC 框架。

答案是肯定和否定的。MVC 模式主张将表示层与应用程序逻辑分离。例如，在设计在线游戏网站 API 时，您可以将游戏的高分表显示为 HTML、XML 或**逗号分隔值**（**CSV**文件）。然而，它的底层模型类将独立于数据最终如何呈现而设计。

MVC 对模型、视图和控制器的功能非常严格。然而，Django 对 web 应用程序采取了更实际的观点。由于 HTTP 协议的性质，对网页的每个请求都独立于任何其他请求。Django 的框架被设计成一个管道来处理每个请求并准备响应。

Django 称之为**模型模板视图**（**MTV**架构。在数据库接口类（模型）、请求处理类（视图）和最终表示的模板语言（模板）之间存在关注点分离。

如果你将其与经典的 MVC 进行比较，a 模型可以与 Django 的模型进行比较；视图通常是 Django 的模板，控制器是框架本身，它处理传入的 HTTP 请求并将其路由到正确的视图函数。

如果这还没有让您感到足够的困惑，Django 更愿意将回调函数命名为视图函数来处理每个 URL。不幸的是，这与 MVC 模式的视图概念无关。

# 福勒模式

2002 年，Martin Fowler 撰写了企业应用程序架构的*模式**，其中描述了他在构建企业应用程序时经常遇到的大约 40 种模式。*

与描述设计模式的 GoF 书不同，福勒的书是关于架构模式的。因此，它们在更高的抽象级别上描述模式，并且在很大程度上与编程语言无关。

Fowler 的模式组织如下：

*   **域逻辑模式**：包括域模型、事务脚本、服务层、表模块
*   **数据源架构模式**：包括行数据网关、表数据网关、数据映射器和活动记录
*   **对象关系行为模式**：包括身份映射、工作单元和惰性负载

*   **对象关系结构模式**：包括外键映射、映射、依赖映射、关联表映射、标识字段、序列化 LOB、嵌入值、继承映射器、单表继承、具体表继承、类表继承

*   **对象关系元数据映射模式**：包括查询对象、元数据映射和存储库

*   **Web 展示模式**：包括页面控制器、前端控制器、模型视图控制器、转换视图、模板视图、应用程序控制器和两步视图
*   **分布模式**：包括数据传输对象和远程门面
*   **离线并发模式**：包括粗粒度锁、隐式锁、乐观离线锁、悲观离线锁
*   **会话状态模式**：包括数据库会话状态、客户端会话状态、服务器会话状态
*   **基本模式**：包括映射器、网关、层超类型、注册表、值对象、分离接口、货币、插件、特例、服务存根和记录集

在构建 Django 应用程序时，了解几乎所有这些模式都很有用。事实上，福勒的网站位于[http://martinfowler.com/eaaCatalog/](http://martinfowler.com/eaaCatalog/) 在网上有这些图案的优秀目录。我强烈建议你去看看。

Django 还实现了许多这样的模式。下表列出了其中一些：

| **福勒模式** | **Django 组件** | **说明** |
| 活动记录 | Django 模型 | 封装数据库访问并在该数据上添加域逻辑 |
| 类表继承 | 模型继承 | 层次结构中的每个实体都映射到一个单独的表 |
| 标识字段 | ID 字段 | 在对象中保存数据库 ID 字段以维护标识 |
| 模板视图 | Django 模板 | 通过在 HTML 中嵌入标记来呈现为 HTML |

# 还有更多的模式吗？

当然可以。模式总是被发现的。像生物一样，一些变异并形成新的模式，例如，MVC 变体，如**模型视图演示者**（**MVP**）、**层次模型视图控制器**（**HMVC**）或**模型视图模型**（**MVVM**）。

随着已知问题的更好解决方案的确定，模式也会随着时间而演变。例如，Singleton 模式曾经被认为是一种设计模式，但现在被认为是一种**反模式**，因为它引入了共享状态，类似于使用全局变量。反模式可以被定义为一种常见的重新发明但对一个问题来说是糟糕的解决方案。其他一些关于目录模式的知名书籍是 Buschman、Meunier、Rohnert、Sommerlad 和 Sta 的**面向模式的软件架构**（**POSA**；*Hohpe*和 Woolf 的*企业整合模式*；以及*网站设计：由*Duyne*、*Landay*、*和 Hong*设计的以客户为中心的网络体验*的模式、原则和流程。

# 本书中的模式

本书将介绍 Django 特定的设计和架构模式，这对 Django 开发人员很有用。以下是每种模式的呈现方式：

**图案名称**

标题是模式名称。如果是众所周知的模式，则使用常用名称；否则，将选择一个简洁、自描述性的名称。名称很重要，因为它们有助于构建模式词汇表。所有图案将包含以下部分：

*   **问题**：这里简单提到了问题
*   **解决方案**：总结了建议的解决方案
*   **问题详情**：这详细说明了问题的背景，并可能给出一个示例
*   **解决方案详细信息**：这对解决方案进行了一般性解释，并提供了一个 Django 实现示例

# 对模式的批评

尽管模式几乎被普遍使用，但也有一些批评。最常见的反对理由如下：

*   **模式弥补了缺少的语言功能**：Peter Norvig 发现设计模式中的 23 个模式中有 16 个在 Lisp 或 Python 等动态语言中是不可见的或更简单的。例如，由于函数在 Python 中已经是对象，因此不需要创建单独的类来实现策略模式。

*   **模式重复最佳实践**：许多模式本质上是最佳实践的形式化，比如关注点分离，可能看起来是多余的。
*   **模式可能会导致过度工程**：与更简单的解决方案相比，实现模式可能效率更低且过度。

# 如何使用模式

尽管之前的一些批评是非常有效的，但它们是基于模式是如何被滥用的。以下是一些建议，可以帮助您了解如何最好地使用设计模式：

*   模式最适合用来传达您正在遵循一种被充分理解的设计方法
*   如果您的语言支持直接解决方案，请不要实现模式
*   不要试图从模式的角度来改造一切
*   仅当模式是您上下文中最优雅的解决方案时才使用它
*   不要害怕创建新的模式

# Python Zen 和 Django 的设计理念

通常，Python 社区使用术语*Pythonic*来描述一段惯用代码。它通常指的是*Python 的禅宗*中阐述的原则。写得像一首诗，描述这样一个模糊的概念是非常有用的。

尝试在 Python 提示符中输入`import this`以查看*Python 的禅宗*。

此外，Django 开发人员在[设计框架时清晰地记录了他们的设计理念 https://docs.djangoproject.com/en/dev/misc/design-philosophies/](https://docs.djangoproject.com/en/dev/misc/design-philosophies/) 。

虽然本文档描述了 Django 设计背后的思想过程，但它对使用 Django 构建应用程序的开发人员也很有用。某些原则，如**不要重复自己**（**DRY**）、**松耦合**和**紧密内聚**可以帮助您编写更易于维护和习惯的 Django 应用程序。

本书建议的 Django 或 Python 最佳实践的格式如下：

在`settings.py`中使用`BASE_DIR`，避免硬编码目录名。

# 总结

在本章中，我们介绍了为什么人们选择 Django 而不是其他 web 框架，它有趣的历史，以及它是如何工作的。我们还研究了设计模式、流行模式集合和最佳实践。

在下一章中，我们将了解 Django 项目开始时的前几个步骤，例如收集需求、创建模型和设置项目。